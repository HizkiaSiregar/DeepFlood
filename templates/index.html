<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>DeepLabV3+ Flood Segmentation System</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Inter", -apple-system, BlinkMacSystemFont, "Segoe UI",
          sans-serif;
        background: linear-gradient(
          180deg,
          #1a2b5c 0%,
          #0a0e27 30%,
          #2d1b3d 70%,
          #0f1419 100%
        );
        color: #ffffff;
        min-height: 100vh;
        overflow-x: hidden;
        position: relative;
      }

      .container {
        max-width: 1400px;
        margin: 0 auto;
        padding: 20px;
        position: relative;
        z-index: 10;
      }

      /* Animated Background */
      .bg-animation {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -2;
        background: linear-gradient(
          45deg,
          #1a2b5c,
          #2a4a7f,
          #0a0e27,
          #2d1b3d,
          #4a2c5e,
          #0f1419
        );
        background-size: 600% 600%;
        animation: gradientShift 12s ease infinite;
      }

      @keyframes gradientShift {
        0% { background-position: 0% 50%; }
        25% { background-position: 100% 25%; }
        50% { background-position: 50% 100%; }
        75% { background-position: 25% 0%; }
        100% { background-position: 0% 50%; }
      }

      /* Floating Bubbles */
      .bubble-container {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        z-index: -1;
        pointer-events: none;
      }

      .bubble {
        position: absolute;
        background: radial-gradient(
          circle,
          rgba(100, 200, 255, 0.15) 0%,
          rgba(77, 208, 225, 0.05) 70%,
          transparent 100%
        );
        border-radius: 50%;
        animation: bubbleFloat 20s infinite linear;
        backdrop-filter: blur(2px);
      }

      @keyframes bubbleFloat {
        0% {
          transform: translateY(100vh) translateX(0px) scale(0);
          opacity: 0;
        }
        10% {
          opacity: 1;
          transform: translateY(90vh) translateX(0px) scale(1);
        }
        90% {
          opacity: 1;
          transform: translateY(-10vh) translateX(var(--drift, 0px)) scale(1);
        }
        100% {
          opacity: 0;
          transform: translateY(-20vh) translateX(var(--drift, 0px)) scale(0);
        }
      }

      /* Navigation - OLD DESIGN STYLE */
      .nav-bar {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 1rem 2rem;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 25px;
        margin-bottom: 2rem;
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
        z-index: 100;
      }

      .nav-left {
        display: flex;
        align-items: center;
      }

      .nav-logo {
        font-size: 1.8rem;
        font-weight: 700;
        background: linear-gradient(45deg, #64c8ff, #4dd0e1);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        display: flex;
        align-items: center;
        gap: 0.5rem;
        line-height: 1;
      }

      .nav-right {
        display: flex;
        gap: 1rem;
        align-items: center;
      }

      .nav-btn {
        background: rgba(255, 255, 255, 0.05);
        color: #64c8ff;
        border: 1px solid rgba(100, 200, 255, 0.3);
        padding: 0.7rem 1.5rem;
        border-radius: 25px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-size: 0.9rem;
        font-weight: 500;
        backdrop-filter: blur(10px);
      }

      .nav-btn:hover {
        background: rgba(100, 200, 255, 0.1);
        border-color: rgba(100, 200, 255, 0.5);
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(100, 200, 255, 0.2);
      }

      .nav-btn:active {
        background: rgba(100, 200, 255, 0.2);
        border-color: rgba(100, 200, 255, 0.7);
        transform: translateY(0px);
        box-shadow: 0 4px 15px rgba(100, 200, 255, 0.3);
      }

      /* Hamburger Menu */
      .hamburger {
        display: none;
        flex-direction: column;
        gap: 5px;
        cursor: pointer;
        padding: 10px;
        z-index: 100000;
        position: relative;
      }

      .hamburger span {
        width: 25px;
        height: 3px;
        background: #64c8ff;
        border-radius: 3px;
        transition: all 0.3s ease;
      }

      .hamburger.active span:nth-child(1) {
        transform: rotate(45deg) translate(8px, 8px);
      }

      .hamburger.active span:nth-child(2) {
        opacity: 0;
      }

      .hamburger.active span:nth-child(3) {
        transform: rotate(-45deg) translate(8px, -8px);
      }

      /* Mobile Menu Overlay - DISABLED */
      .mobile-menu-overlay {
        display: none !important;
        pointer-events: none !important;
      }

      .mobile-menu-overlay.active {
        display: none !important;
        pointer-events: none !important;
      }

      /* Database Status */
      .db-status {
        display: flex;
        align-items: center;
        gap: 8px;
        font-size: 0.8rem;
        color: rgba(255, 255, 255, 0.6);
        margin-bottom: 20px;
        justify-content: center;
      }

      .db-status.connected {
        color: #27ae60;
      }

      .db-status.disconnected {
        color: #e67e22;
      }

      .status-dot {
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: currentColor;
        animation: pulse 2s infinite;
      }

      @keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
      }

      /* Header - OLD FLAT DESIGN (NO CARD) */
      .header {
        text-align: center;
        margin-bottom: 2rem;
      }

      .logo {
        font-size: 3.5rem;
        font-weight: 300;
        background: linear-gradient(135deg, #64c8ff, #4dd0e1, #26c6da);
        -webkit-background-clip: text;
        -webkit-text-fill-color: transparent;
        background-clip: text;
        margin-bottom: 1rem;
        letter-spacing: 2px;
      }

      .tagline {
        color: rgba(255, 255, 255, 0.7);
        font-size: 1.1rem;
        font-weight: 300;
        letter-spacing: 1px;
      }

      .model-info {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.9em;
        margin-top: 10px;
      }

      /* Upload Section - OLD STYLE, MORE COMPACT */
      .upload-section {
        background: rgba(255, 255, 255, 0.05);
        border: 2px dashed rgba(100, 200, 255, 0.3);
        border-radius: 20px;
        padding: 2rem 2rem;
        text-align: center;
        margin: 30px auto;
        max-width: 600px;
        transition: all 0.3s ease;
        cursor: pointer;
        backdrop-filter: blur(20px);
      }

      .upload-section:hover {
        border-color: rgba(100, 200, 255, 0.6);
        background: rgba(100, 200, 255, 0.1);
        transform: translateY(-5px);
      }

      .upload-section h3 {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 1.5rem;
        color: #64c8ff;
      }

      .upload-icon {
        width: 80px;
        height: 80px;
        margin: 0 auto 1.5rem;
        border: 2px solid rgba(100, 200, 255, 0.5);
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 2rem;
        color: #64c8ff;
      }

      .upload-section input[type="file"] {
        display: none;
      }

      .upload-options {
        display: flex;
        justify-content: center;
        gap: 1rem;
        margin-bottom: 2rem;
        flex-wrap: wrap;
      }

      .file-upload-btn {
        display: inline-block;
        background: rgba(100, 200, 255, 0.2);
        border: 2px solid rgba(100, 200, 255, 0.5);
        color: #64c8ff;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .file-upload-btn:hover {
        background: rgba(100, 200, 255, 0.3);
        border-color: #64c8ff;
        transform: translateY(-2px);
      }

      .camera-btn {
        display: inline-block;
        background: rgba(118, 75, 162, 0.2);
        border: 2px solid rgba(118, 75, 162, 0.5);
        color: #a855f7;
        padding: 12px 30px;
        border-radius: 25px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .camera-btn:hover {
        background: rgba(118, 75, 162, 0.3);
        border-color: #a855f7;
        transform: translateY(-2px);
      }

      .file-name-display {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.95rem;
        margin: 10px 0;
        min-height: 24px;
        font-style: italic;
      }

      /* Optional Features - COMPACT INTEGRATED STYLE */
      .optional-features {
        margin-top: 25px;
        padding: 20px;
        background: rgba(100, 200, 255, 0.05);
        border-radius: 15px;
        border: 1px solid rgba(100, 200, 255, 0.2);
      }

      .optional-features h4 {
        color: #64c8ff;
        font-size: 1rem;
        margin-bottom: 15px;
        font-weight: 500;
        text-align: center;
      }

      .checkbox-container {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      .checkbox-item {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 10px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .checkbox-item:hover {
        background: rgba(255, 255, 255, 0.07);
      }

      .checkbox-item input[type="checkbox"] {
        width: 20px;
        height: 20px;
        cursor: pointer;
        accent-color: #667eea;
      }

      .checkbox-item label {
        color: rgba(255, 255, 255, 0.9);
        font-size: 0.95rem;
        cursor: pointer;
        flex: 1;
      }

      .checkbox-desc {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.85rem;
        margin-left: 30px;
        margin-top: 5px;
      }

      /* Camera */
      #cameraVideo {
        max-width: 100%;
        border-radius: 15px;
        margin-top: 20px;
        display: none;
      }

      .camera-controls {
        display: none;
        gap: 10px;
        justify-content: center;
        margin-top: 15px;
      }

      .camera-controls button {
        padding: 10px 20px;
        border-radius: 20px;
        border: none;
        cursor: pointer;
        font-weight: 600;
        transition: all 0.3s ease;
      }

      .capture-photo-btn {
        background: linear-gradient(135deg, #667eea, #764ba2);
        color: white;
      }

      .cancel-camera-btn {
        background: rgba(231, 76, 60, 0.8);
        color: white;
      }

      .image-preview-container {
        text-align: center;
        margin-top: 20px;
        display: none;
      }

      .image-preview {
        max-width: 100%;
        max-height: 300px;
        border-radius: 15px;
        border: 2px solid rgba(100, 200, 255, 0.5);
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.3);
        display: inline-block;
        object-fit: contain;
        margin: 0 auto;
      }

      /* Analyze Button */
      .analyze-button-container {
        text-align: center;
        margin: 2rem 0;
      }

      .btn {
        background: linear-gradient(135deg, #64c8ff, #4dd0e1, #26c6da);
        color: white;
        border: none;
        padding: 1.2rem 3rem;
        font-size: 1.2rem;
        font-weight: 600;
        border-radius: 50px;
        cursor: pointer;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 1px;
      }

      .btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 15px 40px rgba(100, 200, 255, 0.4);
      }

      .btn:disabled {
        opacity: 0.7;
        cursor: not-allowed;
        transform: none;
      }

      /* Progress Section */
      .progress-section {
        display: none;
        background: rgba(255, 255, 255, 0.03);
        padding: 2rem;
        border-radius: 25px;
        margin: 2rem 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
      }

      .progress-text {
        text-align: center;
        font-size: 1.2rem;
        color: #64c8ff;
        font-weight: 600;
        margin-bottom: 1rem;
      }

      .progress-bar-container {
        width: 100%;
        height: 30px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 20px;
        overflow: hidden;
        margin: 1rem 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
      }

      .progress-bar {
        height: 100%;
        background: linear-gradient(45deg, #64c8ff, #4dd0e1, #26c6da);
        width: 0%;
        border-radius: 20px;
        transition: width 0.3s ease;
        display: flex;
        align-items: center;
        justify-content: center;
        color: white;
        font-weight: bold;
        font-size: 0.9rem;
      }

      .progress-message {
        text-align: center;
        color: rgba(255, 255, 255, 0.8);
        font-size: 1rem;
        margin-top: 1rem;
      }

      /* Error Message */
      .error-message {
        background: rgba(231, 76, 60, 0.2);
        border: 1px solid #e74c3c;
        color: #ff6b6b;
        padding: 1rem;
        border-radius: 15px;
        margin: 1rem 0;
        display: none;
        text-align: center;
      }

      /* Results Section */
      .results {
        margin-top: 2rem;
        display: none;
      }

      .results h2 {
        color: #64c8ff;
        margin-bottom: 2rem;
        font-size: 2rem;
        text-align: left;
      }

      /* Image Grid */
      .image-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 2rem;
        margin: 2rem 0;
      }

      .image-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 1.5rem;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        text-align: center;
        transition: all 0.3s ease;
        backdrop-filter: blur(20px);
        overflow: hidden;
      }

      .image-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 15px 40px rgba(100, 200, 255, 0.2);
        border-color: rgba(100, 200, 255, 0.3);
      }

      .image-card h3 {
        color: #64c8ff;
        margin-bottom: 1rem;
        font-size: 1.2rem;
      }

      .image-card img {
        width: 100%;
        height: 280px;
        object-fit: cover;
        border-radius: 10px;
        cursor: pointer;
        transition: all 0.3s ease;
        display: block;
      }

      .image-card img:hover {
        transform: scale(1.02);
      }

      .image-card p {
        font-size: 0.9rem;
        color: rgba(255, 255, 255, 0.7);
        margin-top: 0.5rem;
      }

      /* Location Detection Section */
      .location-detection-section {
        background: rgba(255, 255, 255, 0.03);
        padding: 2rem;
        border-radius: 20px;
        margin: 2rem 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
      }

      .location-cards-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
        gap: 1rem;
        margin-bottom: 1.5rem;
      }

      .location-info-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 1rem;
        border-radius: 12px;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
      }

      .location-info-card:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(100, 200, 255, 0.3);
        transform: translateY(-2px);
      }

      .location-info-card .card-icon {
        font-size: 1.5rem;
        margin-bottom: 0.5rem;
      }

      .location-info-card .card-label {
        color: #64c8ff;
        font-size: 0.85rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        margin-bottom: 0.5rem;
      }

      .location-info-card .card-value {
        color: rgba(255, 255, 255, 0.9);
        font-size: 1.05rem;
        word-break: break-word;
      }

      .location-confidence-bar {
        width: 100%;
        height: 8px;
        background: rgba(255, 255, 255, 0.1);
        border-radius: 4px;
        overflow: hidden;
        margin-top: 0.5rem;
      }

      .location-confidence-fill {
        height: 100%;
        background: linear-gradient(90deg, #64c8ff, #4dd0e1);
        border-radius: 4px;
        transition: width 0.5s ease;
      }

      .location-map-container {
        margin-top: 20px;
        border-radius: 15px;
        overflow: hidden;
        border: 2px solid rgba(100, 200, 255, 0.3);
        box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
      }

      .location-map-container iframe {
        width: 100%;
        height: 450px;
        border: none;
      }

      .landmarks-list {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        margin-top: 0.5rem;
      }

      .landmark-tag {
        background: rgba(100, 200, 255, 0.2);
        color: #64c8ff;
        padding: 0.3rem 0.8rem;
        border-radius: 15px;
        font-size: 0.85rem;
        border: 1px solid rgba(100, 200, 255, 0.3);
      }

      /* Citation Link Styles */
      .citation-link {
        color: #4dd0e1;
        cursor: pointer;
        text-decoration: none;
        font-weight: 600;
        transition: all 0.2s ease;
        padding: 1px 3px;
        border-radius: 3px;
      }

      .citation-link:hover {
        background: rgba(77, 208, 225, 0.2);
        color: #64c8ff;
        text-decoration: underline;
      }

      /* Reference section styling */
      .references-section {
        margin-top: 2rem;
        padding-top: 1.5rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
      }

      .references-section h4 {
        color: #64c8ff;
        font-size: 1.1rem;
        margin-bottom: 1rem;
      }

      .reference-item {
        padding: 0.8rem;
        margin: 0.5rem 0;
        background: rgba(255, 255, 255, 0.02);
        border-left: 3px solid #64c8ff;
        border-radius: 5px;
        font-size: 0.9rem;
        line-height: 1.5;
      }

      .reference-item a {
        color: #4dd0e1;
        text-decoration: none;
        word-break: break-all;
      }

      .reference-item a:hover {
        text-decoration: underline;
        color: #64c8ff;
      }

      /* Gemini Section */
      .gemini-section {
        background: rgba(255, 255, 255, 0.03);
        padding: 2rem;
        border-radius: 20px;
        margin: 2rem 0;
        border: 1px solid rgba(255, 255, 255, 0.1);
        backdrop-filter: blur(20px);
      }

      .gemini-section h3 {
        color: #64c8ff;
        margin-bottom: 1.5rem;
        font-size: 1.3rem;
      }

      .risk-badge {
        display: inline-block;
        padding: 0.5rem 1.5rem;
        border-radius: 25px;
        font-weight: bold;
        font-size: 1rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        margin: 1rem 0;
      }

      .risk-low { background: #27ae60; color: white; }
      .risk-moderate { background: #f39c12; color: white; }
      .risk-high { background: #e67e22; color: white; }
      .risk-critical { background: #e74c3c; color: white; }

      .explanation-text {
        color: rgba(255, 255, 255, 0.9);
        line-height: 1.6;
        font-size: 1rem;
      }

      .explanation-text.collapsed {
        max-height: 150px;
        overflow: hidden;
        position: relative;
      }

      .explanation-text.collapsed::after {
        content: "";
        position: absolute;
        bottom: 0;
        left: 0;
        right: 0;
        height: 50px;
        background: linear-gradient(transparent, rgba(15, 20, 25, 0.9));
      }

      .read-more-btn {
        background: rgba(100, 200, 255, 0.1);
        color: #64c8ff;
        border: 1px solid rgba(100, 200, 255, 0.3);
        padding: 0.5rem 1.5rem;
        border-radius: 20px;
        cursor: pointer;
        margin-top: 1rem;
        font-size: 0.9rem;
        transition: all 0.3s ease;
      }

      .read-more-btn:hover {
        background: rgba(100, 200, 255, 0.2);
        border-color: rgba(100, 200, 255, 0.5);
      }

      /* Metrics Section */
      .metrics-section {
        margin: 2rem 0;
      }

      .metrics-section h3 {
        color: #64c8ff;
        margin-bottom: 1.5rem;
        font-size: 1.3rem;
      }

      .metrics-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 1.5rem;
      }

      .metric-card {
        background: rgba(255, 255, 255, 0.05);
        padding: 1.5rem;
        border-radius: 20px;
        text-align: center;
        border: 1px solid rgba(255, 255, 255, 0.1);
        transition: all 0.3s ease;
        backdrop-filter: blur(10px);
        position: relative;
      }

      .metric-card:hover {
        transform: translateY(-5px);
        box-shadow: 0 10px 30px rgba(100, 200, 255, 0.1);
        border-color: rgba(100, 200, 255, 0.2);
      }

      .metric-card .label {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.95em;
        margin-bottom: 10px;
        font-weight: 500;
      }

      .metric-card .value {
        color: #64c8ff;
        font-size: 2em;
        font-weight: bold;
        margin: 10px 0;
      }

      .metric-card .desc {
        font-size: 0.85em;
        color: rgba(255, 255, 255, 0.5);
        margin-top: 8px;
        line-height: 1.4;
      }

      .metric-badge {
        display: inline-block;
        padding: 5px 12px;
        border-radius: 15px;
        font-size: 0.75em;
        margin-left: 10px;
        color: white;
        font-weight: 600;
      }

      .badge-dynamic {
        background: linear-gradient(135deg, #27ae60, #2ecc71);
        box-shadow: 0 3px 10px rgba(39, 174, 96, 0.3);
      }

      .badge-static {
        background: linear-gradient(135deg, #95a5a6, #7f8c8d);
        box-shadow: 0 3px 10px rgba(149, 165, 166, 0.3);
      }

      /* METRIC VISUALIZATION - OLD DESIGN WITH GRAPHS */
      .metric-visual {
        width: 100%;
        margin: 8px 0;
        background: rgba(100, 200, 255, 0.05);
        border-radius: 8px;
        border: 1px solid rgba(100, 200, 255, 0.1);
        padding: 5px;
        cursor: pointer;
        transition: all 0.3s ease;
        line-height: 0;
      }

      .metric-visual:hover {
        transform: scale(1.02);
        box-shadow: 0 5px 15px rgba(100, 200, 255, 0.3);
      }

      .metric-visual img {
        width: 100%;
        height: auto;
        display: block;
        border-radius: 6px;
      }

      .download-btn {
        background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
        color: white;
        padding: 12px 30px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-size: 1rem;
        font-weight: 600;
        transition: all 0.3s ease;
        box-shadow: 0 5px 15px rgba(39, 174, 96, 0.3);
      }

      .download-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 8px 25px rgba(39, 174, 96, 0.4);
      }

      /* Footer */
      .footer {
        padding: 2rem 0 1rem;
        border-top: 1px solid rgba(255, 255, 255, 0.1);
        text-align: center;
        margin-top: 3rem;
      }

      .footer-text {
        color: rgba(255, 255, 255, 0.5);
        font-size: 0.9rem;
      }

      /* Modal Styles - NEW DESIGN */
      .modal {
        display: none;
        position: fixed;
        z-index: 1000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.8);
        backdrop-filter: blur(5px);
      }

      .modal-content {
        background: linear-gradient(135deg, #1a2b5c 0%, #0a0e27 50%, #2d1b3d 100%);
        margin: 2% auto;
        padding: 0;
        border-radius: 20px;
        width: 95%;
        max-width: 1000px;
        max-height: 90vh;
        overflow-y: auto;
        border: 1px solid rgba(255, 255, 255, 0.1);
        position: relative;
      }

      .modal-header {
        padding: 25px 30px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        display: flex;
        justify-content: space-between;
        align-items: center;
        background: rgba(255, 255, 255, 0.03);
        border-radius: 20px 20px 0 0;
      }

      .modal-header h2 {
        color: #64c8ff;
        font-size: 1.8rem;
        font-weight: 500;
        margin: 0;
      }

      .modal-body {
        padding: 30px;
      }

      .close {
        color: rgba(255, 255, 255, 0.6);
        font-size: 2rem;
        font-weight: bold;
        cursor: pointer;
        transition: color 0.3s ease;
      }

      .close:hover {
        color: #64c8ff;
      }

      /* Welcome Modal Content - OLD TEXT, NEW DESIGN */
      .welcome-content {
        text-align: center;
      }

      .welcome-icon {
        font-size: 3rem;
        margin-bottom: 20px;
        color: #64c8ff;
      }

      .welcome-content h3 {
        color: #64c8ff;
        font-size: 2rem;
        margin-bottom: 20px;
      }

      .welcome-content p {
        line-height: 1.8;
        margin-bottom: 15px;
        font-size: 1.05rem;
        color: rgba(255, 255, 255, 0.8);
      }

      .feature-list {
        text-align: left;
        margin: 30px auto;
        max-width: 600px;
      }

      .feature-item {
        display: flex;
        align-items: flex-start;
        margin-bottom: 15px;
        padding: 15px;
        background: rgba(255, 255, 255, 0.05);
        border-radius: 10px;
        border-left: 3px solid #64c8ff;
      }

      .feature-item .icon {
        font-size: 1.2rem;
        margin-right: 15px;
        color: #64c8ff;
        min-width: 20px;
      }

      .feature-item .text {
        flex: 1;
      }

      .feature-item .text strong {
        color: #4dd0e1;
        display: block;
        margin-bottom: 5px;
      }

      .get-started-btn {
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
        padding: 15px 40px;
        border: none;
        border-radius: 50px;
        cursor: pointer;
        font-size: 1.1rem;
        font-weight: bold;
        margin-top: 30px;
        transition: all 0.3s ease;
      }

      .get-started-btn:hover {
        transform: translateY(-2px);
        box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
      }

      /* History Styles - COMPACT VERSION */
      .history-controls {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        flex-wrap: wrap;
        gap: 15px;
      }

      .history-stats {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.9rem;
      }

      .history-actions {
        display: flex;
        gap: 8px;
        flex-wrap: wrap;
      }

      .history-btn {
        padding: 6px 12px;
        background: rgba(255, 255, 255, 0.05);
        color: #64c8ff;
        border: 1px solid rgba(100, 200, 255, 0.3);
        border-radius: 15px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: all 0.3s ease;
        text-decoration: none;
      }

      .history-btn:hover {
        background: rgba(100, 200, 255, 0.1);
        border-color: rgba(100, 200, 255, 0.5);
        transform: translateY(-1px);
      }

      .history-btn.danger {
        color: #ff6b6b;
        border-color: rgba(255, 107, 107, 0.3);
      }

      .history-btn.danger:hover {
        background: rgba(255, 107, 107, 0.1);
        border-color: rgba(255, 107, 107, 0.5);
      }

      .history-grid {
        display: grid;
        gap: 15px;
      }

      .history-item {
        background: rgba(255, 255, 255, 0.03);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 15px;
        transition: all 0.3s ease;
        cursor: pointer;
      }

      .history-item:hover {
        background: rgba(255, 255, 255, 0.05);
        border-color: rgba(100, 200, 255, 0.3);
        transform: translateY(-2px);
      }

      .history-item-content {
        display: flex;
        align-items: center;
        gap: 15px;
        flex-wrap: wrap;
      }

      .history-thumbnails {
        display: flex;
        gap: 8px;
        flex-shrink: 0;
      }

      .history-thumbnail {
        width: 80px;
        height: 60px;
        border-radius: 8px;
        border: 1px solid rgba(100, 200, 255, 0.3);
        object-fit: cover;
      }

      .flood-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 0.75rem;
        font-weight: bold;
        text-align: center;
        min-width: 60px;
        flex-shrink: 0;
      }

      .flood-low { background: #27ae60; color: white; }
      .flood-moderate { background: #f39c12; color: white; }
      .flood-high { background: #e67e22; color: white; }
      .flood-severe { background: #e74c3c; color: white; }

      .history-details {
        flex: 1;
        min-width: 200px;
      }

      .history-details .title {
        color: #64c8ff;
        font-size: 0.95rem;
        font-weight: 500;
        margin-bottom: 4px;
      }

      .history-details .meta {
        color: rgba(255, 255, 255, 0.6);
        font-size: 0.8rem;
        margin-bottom: 6px;
      }

      .history-details .preview {
        color: rgba(255, 255, 255, 0.7);
        font-size: 0.8rem;
        line-height: 1.3;
      }

      .history-actions-compact {
        display: flex;
        gap: 6px;
        flex-shrink: 0;
      }

      .action-btn-small {
        padding: 4px 8px;
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 10px;
        color: rgba(255, 255, 255, 0.8);
        cursor: pointer;
        font-size: 0.7rem;
        transition: all 0.3s ease;
      }

      .action-btn-small:hover {
        background: rgba(100, 200, 255, 0.1);
        border-color: rgba(100, 200, 255, 0.3);
        color: #64c8ff;
      }

      .action-btn-small.danger:hover {
        background: rgba(255, 107, 107, 0.1);
        border-color: rgba(255, 107, 107, 0.3);
        color: #ff6b6b;
      }

      .empty-history {
        text-align: center;
        padding: 60px 20px;
        color: rgba(255, 255, 255, 0.6);
      }

      .empty-history-icon {
        font-size: 3rem;
        margin-bottom: 15px;
        color: rgba(100, 200, 255, 0.3);
      }

      .empty-history h3 {
        color: #64c8ff;
        font-size: 1.3rem;
        margin-bottom: 10px;
        font-weight: 400;
      }

      /* Image Modal */
      .image-modal {
        display: none;
        position: fixed;
        z-index: 2000;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.9);
        backdrop-filter: blur(5px);
      }

      .image-modal-content {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        max-width: 90%;
        max-height: 90%;
      }

      .image-modal-content img {
        width: 100%;
        height: 100%;
        object-fit: contain;
        border-radius: 10px;
      }

      .image-modal-close {
        position: absolute;
        top: 20px;
        right: 30px;
        color: white;
        font-size: 3rem;
        font-weight: bold;
        cursor: pointer;
        z-index: 2001;
        background: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        width: 50px;
        height: 50px;
        display: flex;
        align-items: center;
        justify-content: center;
        transition: all 0.3s ease;
      }

      .image-modal-close:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: rotate(90deg);
      }

      /* Loading States */
      .loading {
        display: inline-block;
        width: 16px;
        height: 16px;
        border: 2px solid rgba(255, 255, 255, 0.3);
        border-radius: 50%;
        border-top-color: #64c8ff;
        animation: spin 0.8s ease-in-out infinite;
      }

      @keyframes spin {
        to { transform: rotate(360deg); }
      }

      /* Responsive Design */
      @media (max-width: 768px) {
        .container { padding: 15px; }
        .logo { font-size: 2.5rem; }
        .image-grid { grid-template-columns: 1fr; }
        .metrics-grid { grid-template-columns: repeat(2, 1fr); }
        .upload-section { padding: 2rem 1rem; }
        .upload-options { flex-direction: column; }
        .modal-content { width: 95%; margin: 2% auto; }
        .modal-header { padding: 20px; }
        .modal-body { padding: 20px; }
        .history-controls { flex-direction: column; align-items: stretch; }
        .history-actions { justify-content: center; }
        .history-item-content { flex-direction: column; align-items: stretch; text-align: center; gap: 10px; }
        .location-cards-grid { grid-template-columns: 1fr; }
        
        /* Mobile Navigation */
        .nav-bar {
          padding: 1rem;
        }
        
        .nav-logo {
          font-size: 1.4rem;
        }
        
        .hamburger {
          display: flex;
        }
        
        .nav-right {
          position: fixed;
          top: 0;
          right: -100%;
          width: 280px;
          height: 100vh;
          background: linear-gradient(135deg, #1a2b5c 0%, #0a0e27 50%, #2d1b3d 100%);
          backdrop-filter: blur(20px);
          flex-direction: column;
          padding: 80px 20px 20px;
          gap: 0;
          transition: right 0.3s ease;
          z-index: 99999;
          box-shadow: -5px 0 15px rgba(0, 0, 0, 0.3);
          border-left: 1px solid rgba(255, 255, 255, 0.1);
          pointer-events: auto;
        }
        
        .nav-right.active {
          right: 0;
          pointer-events: auto;
        }
        
        .nav-right.active {
          right: 0;
        }
        
        .nav-btn {
          width: 100%;
          text-align: center;
          padding: 1rem;
          margin: 5px 0;
          border-radius: 15px;
          pointer-events: auto !important;
          cursor: pointer !important;
          position: relative;
          z-index: 100001;
          touch-action: manipulation;
        }

        .nav-btn:hover {
          transform: translateY(0px);
          background: rgba(100, 200, 255, 0.15);
        }

        .nav-btn:active {
          background: rgba(100, 200, 255, 0.25);
          border-color: rgba(100, 200, 255, 0.7);
        }
      }

      @media (max-width: 480px) {
        .logo { font-size: 2rem; }
        .metrics-grid { grid-template-columns: 1fr; }
      }
    </style>
  </head>
  <body>
    <div class="bg-animation"></div>
    <div class="bubble-container" id="bubble-container"></div>
    
    <!-- Mobile Menu Overlay -->
    <div class="mobile-menu-overlay" id="mobileMenuOverlay" onclick="toggleMobileMenu()"></div>

    <div class="container">
      <!-- Navigation -->
      <nav class="nav-bar">
        <div class="nav-left">
          <div class="nav-logo">üåä DeepFlood</div>
        </div>
        
        <!-- Hamburger Menu -->
        <div class="hamburger" id="hamburger" onclick="toggleMobileMenu()">
          <span></span>
          <span></span>
          <span></span>
        </div>
        
        <div class="nav-right" id="navRight">
          <button class="nav-btn" onclick="location.reload()">New Analysis</button>
          <button class="nav-btn" onclick="viewHistory()">View History</button>
          <button class="nav-btn" onclick="showWelcome()">About</button>
          <button class="nav-btn" onclick="window.location.href='/about'">Authors</button>
        </div>
      </nav>

      <!-- Database Status -->
      <div class="db-status" id="dbStatus">
        <div class="status-dot"></div>
        <span>Checking database connection...</span>
      </div>

      <!-- Header -->
      <div class="header">
        <div class="logo">A DeepLabv3+ SEGMENTATION</div>
        <div class="tagline">Advanced AI-Powered Flood Segmentation with Grad-CAM Explainability</div>
        <p class="model-info">Backbone: {{ backbone_name }} | Training: 100 Epochs | DeepLabV3+</p>
      </div>

      <!-- Error Message -->
      <div class="error-message" id="errorMessage"></div>

      <!-- Upload Section - OLD STYLE -->
      <div class="upload-section">
        <div class="upload-icon">üì§</div>
        <h3>Upload Aerial Image or Use Camera</h3>
        
        <input type="file" id="imageFile" accept="image/*" />
        <div class="upload-options">
          <label for="imageFile" class="file-upload-btn">Choose File</label>
          <button class="camera-btn" onclick="startCamera()">Use Camera</button>
        </div>

        <div class="file-name-display" id="fileNameDisplay">No file selected</div>

        <!-- Optional Features -->
        <div class="optional-features">
          <h4>üìã Optional Analysis Features</h4>
          <div class="checkbox-container">
            <div class="checkbox-item">
              <input type="checkbox" id="enableCitations" name="enableCitations">
              <label for="enableCitations">
                <div>Include Academic Citations</div>
                <div class="checkbox-desc">Add IEEE-style references to AI analysis</div>
              </label>
            </div>
            <div class="checkbox-item">
              <input type="checkbox" id="enableLocation" name="enableLocation">
              <label for="enableLocation">
                <div>Detect Location from Image</div>
                <div class="checkbox-desc">Identify landmarks and show on map</div>
              </label>
            </div>
          </div>
        </div>

        <!-- Camera Video -->
        <video id="cameraVideo" autoplay playsinline></video>
        <div class="camera-controls">
          <button class="capture-photo-btn" onclick="capturePhoto()">Capture Photo</button>
          <button class="cancel-camera-btn" onclick="stopCamera()">Cancel</button>
        </div>

        <!-- Image Preview -->
        <div class="image-preview-container" id="previewContainer">
          <img id="imagePreview" class="image-preview" alt="Image Preview" />
        </div>
      </div>

      <!-- Analyze Button -->
      <div class="analyze-button-container" id="analyzeContainer">
        <button class="btn" id="analyzeBtn" onclick="analyze()">Analyze Flood Segmentation</button>
      </div>

      <!-- Progress Bar Section -->
      <div class="progress-section" id="progressSection">
        <div class="progress-text">Processing...</div>
        <div class="progress-bar-container">
          <div class="progress-bar" id="progressBar">0%</div>
        </div>
        <div class="progress-message" id="progressMessage">Initializing...</div>
      </div>

      <!-- Results Section -->
      <div class="results" id="results">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px;">
          <h2 style="margin: 0">Flood Segmentation Results</h2>
          <button class="download-btn" id="downloadBtn" onclick="downloadPDF()">Download Report PDF</button>
        </div>

        <!-- Image Grid -->
        <div class="image-grid">
          <div class="image-card">
            <h3>Original Image</h3>
            <img id="original" alt="Original" onclick="enlargeImage(this)" />
          </div>
          <div class="image-card">
            <h3>Segmentation Mask</h3>
            <img id="prediction" alt="Prediction" onclick="enlargeImage(this)" />
            <p>White = Flood | Black = No Flood</p>
          </div>
          <div class="image-card">
            <h3>Grad-CAM Heatmap</h3>
            <img id="gradcam" alt="Grad-CAM" onclick="enlargeImage(this)" />
            <p>Shows where model focused attention</p>
          </div>
          <div class="image-card">
            <h3>Flood Overlay</h3>
            <img id="overlay" alt="Overlay" onclick="enlargeImage(this)" />
            <p>Red = Segmented Flood Areas</p>
          </div>
        </div>

        <!-- Location Detection Section -->
        <div class="location-detection-section" id="locationDetectionSection" style="display: none;">
          <h3 style="color: #64c8ff; margin-bottom: 1.5rem; font-size: 1.4rem;">
            üåç Detected Location from Image
          </h3>
          
          <div class="location-cards-grid" id="locationCardsGrid">
            <!-- Location cards will be inserted here by JavaScript -->
          </div>
          
          <div class="location-map-container" id="locationMapContainer" style="display: none;">
            <!-- Map will be inserted here if coordinates are available -->
          </div>
          
          <div class="no-location-message" id="noLocationMessage" style="display: none;">
            <div style="text-align: center; padding: 30px; color: rgba(255, 255, 255, 0.6);">
              <div style="font-size: 2.5rem; margin-bottom: 15px;">üó∫Ô∏è</div>
              <p>Location could not be determined from this image.</p>
              <p style="font-size: 0.9rem; margin-top: 10px;">No identifiable landmarks or geographic features were detected.</p>
            </div>
          </div>
        </div>

        <!-- Gemini Analysis Section -->
        <div class="gemini-section">
          <h3>ü§ñ AI-Generated Analysis Report</h3>
          <p style="color: rgba(255, 255, 255, 0.6); font-size: 0.9rem; margin-bottom: 1rem;">
            Powered by Google Gemini 2.0 Flash ‚Ä¢ DeepLabV3+ Segmentation Model
          </p>
          
          <div style="text-align: center; margin: 20px 0">
            <span id="riskBadge" class="risk-badge"></span>
          </div>
          
          <div id="geminiExplanation" class="explanation-text"></div>
          
          <div style="text-align: center;">
            <button class="read-more-btn" id="readMoreBtn" onclick="toggleReadMore()" style="display: none;">
              Read More ‚ñº
            </button>
          </div>
        </div>

        <!-- Metrics Sections -->
        <div class="metrics-section">
          <h3>This Image's Analysis <span class="metric-badge badge-dynamic">DYNAMIC - Changes Per Image</span></h3>
          <div class="metrics-grid" id="imageMetrics"></div>
        </div>

        <div class="metrics-section">
          <h3>Model Performance (Training) <span class="metric-badge badge-static">STATIC - From Validation Set</span></h3>
          <div class="metrics-grid" id="modelMetrics"></div>
        </div>
      </div>

      <!-- Footer -->
      <footer class="footer">
        <div class="footer-text">¬© 2025 DeepFlood Segmentation System. Powered by AI for disaster management.</div>
      </footer>
    </div>

    <!-- Welcome Modal - COMPLETE OLD TEXT -->
    <div id="welcomeModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>Welcome to DeepFlood</h2>
          <span class="close" onclick="closeWelcome()">&times;</span>
        </div>
        <div class="modal-body">
          <div class="welcome-content">
            <div class="welcome-icon">üåä</div>
            <h3>AI-Powered Flood Detection System</h3>
            <p>DeepFlood uses advanced deep learning to analyze aerial and satellite imagery for flood detection and assessment.</p>
            
            <div class="feature-list">
              <div class="feature-item">
                <div class="icon">‚Ä¢</div>
                <div class="text">
                  <strong>DeepLabV3+ Architecture</strong>
                  State-of-the-art semantic segmentation model trained for precise flood area detection
                </div>
              </div>
              <div class="feature-item">
                <div class="icon">‚Ä¢</div>
                <div class="text">
                  <strong>Grad-CAM Explainability</strong>
                  Visual explanations showing which image regions influenced the model's predictions
                </div>
              </div>
              <div class="feature-item">
                <div class="icon">‚Ä¢</div>
                <div class="text">
                  <strong>AI Analysis Reports</strong>
                  Gemini AI generates comprehensive expert-level analysis of flood risk and coverage
                </div>
              </div>
              <div class="feature-item">
                <div class="icon">‚Ä¢</div>
                <div class="text">
                  <strong>Detailed Metrics</strong>
                  Real-time confidence scores, flood coverage percentage, and model performance statistics
                </div>
              </div>
            </div>

            <div style="margin-top: 30px; text-align: left;">
              <h4 style="color: #64c8ff; font-size: 1.3rem; margin-bottom: 15px; text-align: center;">Understanding Flood Severity Levels</h4>
              <p style="margin-bottom: 15px; font-size: 0.95rem; color: rgba(255, 255, 255, 0.8); text-align: center;">Our system classifies flood risk into four categories based on the percentage of flooded area:</p>
              
              <div class="feature-item" style="border-left: 3px solid #27ae60;">
                <div class="icon" style="color: #27ae60;">‚óè</div>
                <div class="text">
                  <strong style="color: #27ae60;">Low Severity (0-15%)</strong>
                  Minimal risk to infrastructure and population. Routine monitoring sufficient.
                </div>
              </div>
              
              <div class="feature-item" style="border-left: 3px solid #f39c12;">
                <div class="icon" style="color: #f39c12;">‚óè</div>
                <div class="text">
                  <strong style="color: #f39c12;">Moderate Severity (15-40%)</strong>
                  Moderate risk requiring attention. Emergency response protocols should be prepared.
                </div>
              </div>
              
              <div class="feature-item" style="border-left: 3px solid #e67e22;">
                <div class="icon" style="color: #e67e22;">‚óè</div>
                <div class="text">
                  <strong style="color: #e67e22;">High Severity (40-70%)</strong>
                  Significant risk requiring immediate action. Emergency response procedures must be initiated.
                </div>
              </div>
              
              <div class="feature-item" style="border-left: 3px solid #e74c3c;">
                <div class="icon" style="color: #e74c3c;">‚óè</div>
                <div class="text">
                  <strong style="color: #e74c3c;">Critical Severity (70-100%)</strong>
                  Extreme danger requiring urgent action. Immediate evacuation and full emergency response required.
                </div>
              </div>
            </div>

            <p style="margin-top: 20px; font-size: 0.95rem; color: rgba(255, 255, 255, 0.7);">
              Simply upload an aerial image or capture one with your camera, and our AI will analyze it within seconds
            </p>

            <button class="get-started-btn" onclick="closeWelcome()">Get Started</button>
          </div>
        </div>
      </div>
    </div>

    <!-- History Modal - COMPACT VERSION WITHOUT EXPORT -->
    <div id="historyModal" class="modal">
      <div class="modal-content">
        <div class="modal-header">
          <h2>üìä Analysis History</h2>
          <span class="close" onclick="closeHistoryModal()">&times;</span>
        </div>
        <div class="modal-body">
          <div class="history-controls">
            <div class="history-stats" id="historyStats">
              <span class="loading"></span> Loading...
            </div>
            <div class="history-actions">
              <button class="history-btn" onclick="refreshHistory()">üîÑ Refresh</button>
              <button class="history-btn danger" onclick="clearAllHistory()">üóëÔ∏è Clear All</button>
            </div>
          </div>
          
          <div class="history-grid" id="historyGrid">
            <!-- History items will be populated here -->
          </div>
        </div>
      </div>
    </div>

    <!-- Image Modal -->
    <div id="imageModal" class="image-modal" onclick="closeImageModal()">
      <span class="image-modal-close" onclick="closeImageModal()">&times;</span>
      <div class="image-modal-content">
        <img id="imageModalImg" src="" alt="Enlarged view">
      </div>
    </div>

    <script>
      // Global variables
      let currentAnalysisData = null;
      let cameraStream = null;
      let capturedImageFile = null;
      let historyData = [];
      let dbConnected = false;

      // Mobile menu functions
      function toggleMobileMenu() {
        console.log('toggleMobileMenu called!');
        const navRight = document.getElementById('navRight');
        const hamburger = document.getElementById('hamburger');
        const overlay = document.getElementById('mobileMenuOverlay');
        
        const isOpen = navRight.classList.contains('active');
        
        if (isOpen) {
          // Close menu
          navRight.classList.remove('active');
          hamburger.classList.remove('active');
          overlay.classList.remove('active');
          console.log('Menu is now: CLOSED');
        } else {
          // Open menu
          navRight.classList.add('active');
          hamburger.classList.add('active');
          overlay.classList.add('active');
          console.log('Menu is now: OPEN');
          
          // Add click listener to close menu when clicking outside
          setTimeout(() => {
            document.addEventListener('click', closeMenuOnClickOutside);
          }, 100);
        }
      }
      
      function closeMenuOnClickOutside(event) {
        const navRight = document.getElementById('navRight');
        const hamburger = document.getElementById('hamburger');
        
        // Check if click is outside menu and hamburger
        if (!navRight.contains(event.target) && !hamburger.contains(event.target)) {
          closeMobileMenu();
          document.removeEventListener('click', closeMenuOnClickOutside);
        }
      }

      function closeMobileMenu() {
        console.log('closeMobileMenu called!');
        const navRight = document.getElementById('navRight');
        const hamburger = document.getElementById('hamburger');
        const overlay = document.getElementById('mobileMenuOverlay');
        
        navRight.classList.remove('active');
        hamburger.classList.remove('active');
        overlay.classList.remove('active');
        
        // Remove click listener
        document.removeEventListener('click', closeMenuOnClickOutside);
      }

      // Initialize
      document.addEventListener('DOMContentLoaded', function() {
        // Clear the welcome flag so modal always shows
        localStorage.removeItem('deepflood_welcomed');
        
        checkDatabaseStatus();
        setupEventListeners();
        showWelcomeModal();
        createBubbles();
      });

      function setupEventListeners() {
        const fileInput = document.getElementById('imageFile');
        fileInput.addEventListener('change', handleFileSelect);
      }

      function handleFileSelect(e) {
        const file = e.target.files[0];
        if (file) {
          displayFileInfo(file);
          capturedImageFile = file;
          stopCamera();
        }
      }

      function displayFileInfo(file) {
        const fileDisplay = document.getElementById('fileNameDisplay');
        const previewContainer = document.getElementById('previewContainer');
        const imagePreview = document.getElementById('imagePreview');
        const analyzeBtn = document.getElementById('analyzeBtn');
        
        fileDisplay.textContent = `Selected: ${file.name} (${(file.size / 1024 / 1024).toFixed(2)} MB)`;
        analyzeBtn.disabled = false;
        
        const reader = new FileReader();
        reader.onload = function(e) {
          imagePreview.src = e.target.result;
          previewContainer.style.display = 'block';
        };
        reader.readAsDataURL(file);
      }

      function showWelcomeModal() {
        // Show welcome modal every time page loads
        document.getElementById('welcomeModal').style.display = 'block';
        console.log('Welcome modal opened on page load!');
      }

      function showWelcome() {
        console.log('showWelcome called!');
        document.getElementById('welcomeModal').style.display = 'block';
        setTimeout(() => closeMobileMenu(), 100);
      }

      function closeWelcome() {
        document.getElementById('welcomeModal').style.display = 'none';
      }

      function createBubbles() {
        function createBubble() {
          const bubble = document.createElement("div");
          bubble.className = "bubble";
          const size = Math.random() * 80 + 20;
          const startX = Math.random() * window.innerWidth;
          const drift = (Math.random() - 0.5) * 200;
          const duration = Math.random() * 15 + 10;
          bubble.style.width = size + "px";
          bubble.style.height = size + "px";
          bubble.style.left = startX + "px";
          bubble.style.setProperty("--drift", drift + "px");
          bubble.style.animationDuration = duration + "s";
          document.getElementById("bubble-container").appendChild(bubble);
          setTimeout(() => bubble.remove(), duration * 1000);
        }

        setInterval(createBubble, 3000);
        for (let i = 0; i < 5; i++) setTimeout(createBubble, i * 600);
      }

      function checkDatabaseStatus() {
        fetch('/health')
          .then(response => response.json())
          .then(status => {
            const dbStatusEl = document.getElementById('dbStatus');
            if (status.database_available) {
              dbStatusEl.className = 'db-status connected';
              dbStatusEl.innerHTML = '<div class="status-dot"></div><span>Database connected</span>';
              dbConnected = true;
            } else {
              dbStatusEl.className = 'db-status disconnected';
              dbStatusEl.innerHTML = '<div class="status-dot"></div><span>Database offline</span>';
              dbConnected = false;
            }
          })
          .catch(error => {
            const dbStatusEl = document.getElementById('dbStatus');
            dbStatusEl.className = 'db-status disconnected';
            dbStatusEl.innerHTML = '<div class="status-dot"></div><span>Cannot reach server</span>';
            dbConnected = false;
          });
      }

      async function viewHistory() {
        console.log('viewHistory called!');
        document.getElementById('historyModal').style.display = 'block';
        setTimeout(() => closeMobileMenu(), 100);
        await loadHistory();
      }

      function closeHistoryModal() {
        document.getElementById('historyModal').style.display = 'none';
      }

      async function loadHistory() {
        const historyGrid = document.getElementById('historyGrid');
        const historyStats = document.getElementById('historyStats');
        
        historyStats.innerHTML = '<span class="loading"></span> Loading...';
        historyGrid.innerHTML = '';

        if (!dbConnected) {
          historyGrid.innerHTML = `
            <div class="empty-history">
              <div class="empty-history-icon">üîå</div>
              <h3>Database Offline</h3>
              <p>Database connection required to view history.</p>
            </div>
          `;
          historyStats.textContent = 'Database offline';
          return;
        }

        try {
          const response = await fetch('/api/history?limit=50');
          const data = await response.json();
          
          if (data.success && data.analyses.length > 0) {
            historyData = data.analyses;
            displayHistory(historyData);
            historyStats.textContent = `${data.count} analyses found`;
          } else {
            historyGrid.innerHTML = `
              <div class="empty-history">
                <div class="empty-history-icon">üìä</div>
                <h3>No Analysis History</h3>
                <p>Start analyzing flood images to build your history.</p>
            </div>
            `;
            historyStats.textContent = 'No analyses found';
          }
        } catch (error) {
          historyGrid.innerHTML = `
            <div class="empty-history">
              <div class="empty-history-icon">‚ùå</div>
              <h3>Error Loading History</h3>
              <p>Could not connect to database: ${error.message}</p>
            </div>
          `;
          historyStats.textContent = 'Error loading';
        }
      }


      function displayHistory(analyses) {
        const historyGrid = document.getElementById('historyGrid');
        historyGrid.innerHTML = '';

        analyses.forEach((analysis, index) => {
          const floodClass = getFloodClass(analysis.flood_percentage);
          const hasOriginal = analysis.images && analysis.images.original;
          const hasPrediction = analysis.images && analysis.images.prediction;
          const timestamp = analysis.timestamp ? new Date(analysis.timestamp).toLocaleString() : 'Unknown date';
          const filename = analysis.filename || 'Unknown file';
          const severity = analysis.severity_level || 'unknown';
          const floodPercent = analysis.flood_percentage?.toFixed(1) || '0.0';
          const geminiPreview = analysis.gemini_analysis ? (analysis.gemini_analysis.substring(0, 100) + '...') : 'No analysis available';
          
          const historyItem = document.createElement('div');
          historyItem.className = 'history-item';
          historyItem.innerHTML = `
            <div class="history-item-content">
              <div class="history-thumbnails">
                ${hasOriginal ? 
                  `<img src="data:image/png;base64,${analysis.images.original}" class="history-thumbnail" alt="Original" onerror="this.style.display='none';">` 
                  : `<div style="display: flex; width: 80px; height: 60px; background: rgba(255,255,255,0.1); border: 1px dashed rgba(255,255,255,0.3); border-radius: 8px; align-items: center; justify-content: center; color: rgba(255,255,255,0.5); font-size: 10px;">No image</div>`
                }
                ${hasPrediction ? 
                  `<img src="data:image/png;base64,${analysis.images.prediction}" class="history-thumbnail" alt="Mask" onerror="this.style.display='none';">` 
                  : `<div style="display: flex; width: 80px; height: 60px; background: rgba(255,255,255,0.1); border: 1px dashed rgba(255,255,255,0.3); border-radius: 8px; align-items: center; justify-content: center; color: rgba(255,255,255,0.5); font-size: 10px;">No mask</div>`
                }
              </div>
              <div class="flood-badge ${floodClass}">${floodPercent}%</div>
              <div class="history-details">
                <div class="title">${filename}</div>
                <div class="meta">Severity: ${severity} ‚Ä¢ ${timestamp}</div>
                <div class="preview">${geminiPreview}</div>
              </div>
              <div class="history-actions-compact">
                <button class="action-btn-small" onclick="viewAnalysisFromHistory('${analysis._id}')">View</button>
                <button class="action-btn-small danger" onclick="deleteAnalysis('${analysis._id}')">Delete</button>
              </div>
            </div>
          `;
          historyGrid.appendChild(historyItem);
        });
      }

      function getFloodClass(percentage) {
        if (percentage < 10) return 'flood-low';
        if (percentage < 30) return 'flood-moderate';
        if (percentage < 60) return 'flood-high';
        return 'flood-severe';
      }

      async function viewAnalysisFromHistory(analysisId) {
        try {
          const response = await fetch(`/api/analysis/${analysisId}`);
          const data = await response.json();
          
          if (data.success) {
            closeHistoryModal();
            const analysis = data.analysis;
            const result = {
              original: analysis.images?.original || '',
              prediction: analysis.images?.prediction || '',
              gradcam: analysis.images?.gradcam || '',
              overlay: analysis.images?.overlay || '',
              flood_percentage: analysis.flood_percentage,
              flooded_pixels: analysis.flooded_pixels,
              prediction_confidence: analysis.prediction_confidence,
              max_confidence: analysis.max_confidence,
              min_confidence: analysis.min_confidence,
              mean_confidence: analysis.mean_confidence,
              model_iou: analysis.model_metrics?.iou || 0,
              model_miou: analysis.model_metrics?.miou || 0,
              model_accuracy: analysis.model_metrics?.accuracy || 0,
              model_precision: analysis.model_metrics?.precision || 0,
              model_recall: analysis.model_metrics?.recall || 0,
              model_f1_score: analysis.model_metrics?.f1_score || 0,
              model_dice: analysis.model_metrics?.dice || 0,
              gemini_analysis: analysis.gemini_analysis,
              location_data: analysis.location_data
            };
            displayResults(result);
          } else {
            alert('Could not load analysis: ' + data.error);
          }
        } catch (error) {
          alert('Error loading analysis: ' + error.message);
        }
      }

      async function deleteAnalysis(analysisId) {
        if (!confirm('Delete this analysis?')) return;
        try {
          const response = await fetch(`/api/delete/${analysisId}`, { method: 'DELETE' });
          const data = await response.json();
          if (data.success) {
            await loadHistory();
          } else {
            alert('Could not delete: ' + data.error);
          }
        } catch (error) {
          alert('Error: ' + error.message);
        }
      }

      async function clearAllHistory() {
        if (!confirm('Delete ALL history? This cannot be undone.')) return;
        try {
          const response = await fetch('/api/delete-all', { method: 'DELETE' });
          const data = await response.json();
          if (data.success) {
            alert(`Deleted ${data.deleted_count} analyses.`);
            await loadHistory();
          } else {
            alert('Could not clear history: ' + data.error);
          }
        } catch (error) {
          alert('Error: ' + error.message);
        }
      }

      async function refreshHistory() {
        await loadHistory();
      }

      async function startCamera() {
        try {
          const fileInput = document.getElementById('imageFile');
          fileInput.value = '';
          document.getElementById('previewContainer').style.display = 'none';
          
          cameraStream = await navigator.mediaDevices.getUserMedia({ 
            video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } 
          });
          
          const video = document.getElementById('cameraVideo');
          video.srcObject = cameraStream;
          video.style.display = 'block';
          document.querySelector('.camera-controls').style.display = 'flex';
          document.getElementById('fileNameDisplay').textContent = 'Camera ready - capture when ready';
        } catch (error) {
          alert('Camera access denied or not available: ' + error.message);
        }
      }

      function capturePhoto() {
        const video = document.getElementById('cameraVideo');
        const canvas = document.createElement('canvas');
        const context = canvas.getContext('2d');
        canvas.width = video.videoWidth;
        canvas.height = video.videoHeight;
        context.drawImage(video, 0, 0);
        
        canvas.toBlob(function(blob) {
          const file = new File([blob], 'captured_image.jpg', { type: 'image/jpeg' });
          capturedImageFile = file;
          const preview = document.getElementById('imagePreview');
          const previewContainer = document.getElementById('previewContainer');
          preview.src = URL.createObjectURL(blob);
          previewContainer.style.display = 'block';
          document.getElementById('analyzeBtn').disabled = false;
          document.getElementById('fileNameDisplay').textContent = 'Photo captured successfully';
          stopCamera();
        }, 'image/jpeg', 0.8);
      }

      function stopCamera() {
        if (cameraStream) {
          cameraStream.getTracks().forEach(track => track.stop());
          cameraStream = null;
        }
        const video = document.getElementById('cameraVideo');
        video.srcObject = null;
        video.style.display = 'none';
        document.querySelector('.camera-controls').style.display = 'none';
      }

      async function analyze() {
        const analyzeBtn = document.getElementById('analyzeBtn');
        const progressSection = document.getElementById('progressSection');
        const progressBar = document.getElementById('progressBar');
        const progressMessage = document.getElementById('progressMessage');
        const results = document.getElementById('results');
        
        if (!capturedImageFile) {
          showError('Please select an image first');
          return;
        }

        progressSection.style.display = 'block';
        results.style.display = 'none';
        document.getElementById('errorMessage').style.display = 'none';
        analyzeBtn.disabled = true;
        analyzeBtn.textContent = 'Analyzing...';

        try {
          const formData = new FormData();
          formData.append('image', capturedImageFile);
          formData.append('enable_citations', document.getElementById('enableCitations').checked);
          formData.append('enable_location', document.getElementById('enableLocation').checked);
          
          const response = await fetch("/predict", { method: "POST", body: formData });
          const data = await response.json();

          if (data.error) {
            showError("Error: " + data.error);
            progressSection.style.display = "none";
            analyzeBtn.disabled = false;
            analyzeBtn.textContent = "Analyze Flood Segmentation";
            return;
          }

          const taskId = data.task_id;
          let progressInterval = setInterval(async () => {
            try {
              const progressResponse = await fetch(`/progress/${taskId}`);
              const progressData = await progressResponse.json();

              if (progressData.error) {
                clearInterval(progressInterval);
                showError("Error: " + progressData.error);
                progressSection.style.display = "none";
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = "Analyze Flood Segmentation";
                return;
              }

              progressBar.style.width = progressData.progress + '%';
              progressBar.textContent = progressData.progress + '%';
              progressMessage.textContent = progressData.message;

              if (progressData.completed) {
                clearInterval(progressInterval);
                if (progressData.result) {
                  displayResults(progressData.result);
                  progressSection.style.display = "none";
                } else if (progressData.error) {
                  showError("Error: " + progressData.error);
                  progressSection.style.display = "none";
                }
                analyzeBtn.disabled = false;
                analyzeBtn.textContent = "Analyze Flood Segmentation";
              }
            } catch (error) {
              clearInterval(progressInterval);
              showError("Error checking progress: " + error.message);
              progressSection.style.display = "none";
              analyzeBtn.disabled = false;
              analyzeBtn.textContent = "Analyze Flood Segmentation";
            }
          }, 500);
        } catch (error) {
          showError("Error: " + error.message);
          progressSection.style.display = "none";
          analyzeBtn.disabled = false;
          analyzeBtn.textContent = "Analyze Flood Segmentation";
        }
      }

      function showError(message) {
        const errorMsg = document.getElementById("errorMessage");
        errorMsg.textContent = message;
        errorMsg.style.display = "block";
        errorMsg.scrollIntoView({ behavior: "smooth", block: "center" });
      }

      function displayLocationData(locationData) {
        const locationSection = document.getElementById('locationDetectionSection');
        const locationCardsGrid = document.getElementById('locationCardsGrid');
        const locationMapContainer = document.getElementById('locationMapContainer');
        const noLocationMessage = document.getElementById('noLocationMessage');
        
        locationSection.style.display = 'block';
        
        if (locationData && locationData.place_name && locationData.place_name !== 'Unknown') {
          noLocationMessage.style.display = 'none';
          locationCardsGrid.innerHTML = '';
          
          const locationInfo = [
            { icon: 'üìç', label: 'Place', value: locationData.place_name || 'Unknown', show: true },
            { icon: 'üåé', label: 'Region', value: locationData.region || 'Unknown', show: locationData.region && locationData.region !== 'Unknown' },
            { icon: 'üéØ', label: 'Confidence', value: locationData.confidence ? `${(locationData.confidence * 100).toFixed(0)}%` : 'N/A', show: locationData.confidence !== undefined, showBar: true, barValue: locationData.confidence || 0 },
            { icon: 'üó∫Ô∏è', label: 'Coordinates', value: locationData.coordinates ? `${locationData.coordinates.lat.toFixed(4)}, ${locationData.coordinates.lng.toFixed(4)}` : 'Not available', show: locationData.coordinates }
          ];
          
          locationInfo.forEach(info => {
            if (info.show) {
              const card = document.createElement('div');
              card.className = 'location-info-card';
              card.innerHTML = `
                <div class="card-icon">${info.icon}</div>
                <div class="card-label">${info.label}</div>
                <div class="card-value">${info.value}</div>
                ${info.showBar ? `<div class="location-confidence-bar"><div class="location-confidence-fill" style="width: ${info.barValue * 100}%"></div></div>` : ''}
              `;
              locationCardsGrid.appendChild(card);
            }
          });
          
          if (locationData.landmarks && locationData.landmarks.length > 0) {
            const landmarksCard = document.createElement('div');
            landmarksCard.className = 'location-info-card';
            landmarksCard.style.gridColumn = 'span 2';
            landmarksCard.innerHTML = `
              <div class="card-icon">üèõÔ∏è</div>
              <div class="card-label">Identified Landmarks</div>
              <div class="landmarks-list">
                ${locationData.landmarks.map(landmark => `<span class="landmark-tag">${landmark}</span>`).join('')}
              </div>
            `;
            locationCardsGrid.appendChild(landmarksCard);
          }
          
          if (locationData.reasoning) {
            const reasoningCard = document.createElement('div');
            reasoningCard.className = 'location-info-card';
            reasoningCard.style.gridColumn = '1 / -1';
            reasoningCard.innerHTML = `
              <div class="card-icon">üí°</div>
              <div class="card-label">Detection Reasoning</div>
              <div class="card-value" style="font-size: 0.95rem; line-height: 1.6;">${locationData.reasoning}</div>
            `;
            locationCardsGrid.appendChild(reasoningCard);
          }
          
          if (locationData.coordinates) {
            locationMapContainer.style.display = 'block';
            const lat = locationData.coordinates.lat;
            const lng = locationData.coordinates.lng;
            locationMapContainer.innerHTML = `
              <iframe src="https://www.openstreetmap.org/export/embed.html?bbox=${lng-0.02},${lat-0.02},${lng+0.02},${lat+0.02}&layer=mapnik&marker=${lat},${lng}" style="border: none; width: 100%; height: 450px;"></iframe>
              <div style="text-align: center; padding: 10px; background: rgba(0,0,0,0.3);">
                <small style="color: rgba(255,255,255,0.7);"><a href="https://www.openstreetmap.org/?mlat=${lat}&mlon=${lng}#map=15/${lat}/${lng}" target="_blank" style="color: #64c8ff; text-decoration: none;">View Larger Map ‚Üí</a></small>
              </div>
            `;
          } else {
            locationMapContainer.style.display = 'none';
          }
        } else {
          noLocationMessage.style.display = 'block';
          locationCardsGrid.innerHTML = '';
          locationMapContainer.style.display = 'none';
        }
      }

      function makeCitationsClickable(text) {
        if (!text) return '';
        const parts = text.split(/References?:/i);
        let mainContent = parts[0];
        let references = parts.length > 1 ? parts[1] : '';
        const referenceMap = {};
        const referenceLines = references.split('\n').filter(line => line.trim());
        
        referenceLines.forEach(line => {
          const match = line.match(/\[(\d+)\](.+?)(?:https?:\/\/[^\s]+)/);
          if (match) {
            const num = match[1];
            const urlMatch = line.match(/(https?:\/\/[^\s]+)/);
            if (urlMatch) referenceMap[num] = urlMatch[1];
          }
        });
        
        mainContent = mainContent.replace(/\[(\d+)\]/g, (match, num) => {
          if (referenceMap[num]) {
            return `<a href="${referenceMap[num]}" target="_blank" class="citation-link" title="View reference ${num}">[${num}]</a>`;
          }
          return match;
        });
        
        if (references) {
          let formattedRefs = '<div class="references-section"><h4>References:</h4>';
          referenceLines.forEach(line => {
            if (line.trim()) {
              const formattedLine = line.replace(/(https?:\/\/[^\s]+)/g, '<a href="$1" target="_blank">$1</a>');
              formattedRefs += `<div class="reference-item">${formattedLine}</div>`;
            }
          });
          formattedRefs += '</div>';
          return mainContent + formattedRefs;
        }
        return mainContent;
      }

      function displayResults(data) {
        currentAnalysisData = data;
        document.getElementById("original").src = "data:image/png;base64," + data.original;
        document.getElementById("prediction").src = "data:image/png;base64," + data.prediction;
        document.getElementById("gradcam").src = "data:image/png;base64," + data.gradcam;
        document.getElementById("overlay").src = "data:image/png;base64," + data.overlay;

        const locationSection = document.getElementById('locationDetectionSection');
        if (data.location_data && data.location_data.place_name && data.location_data.place_name !== 'Unknown') {
          displayLocationData(data.location_data);
          locationSection.style.display = 'block';
        } else {
          locationSection.style.display = 'none';
        }

        const riskBadge = document.getElementById("riskBadge");
        const floodPercent = data.flood_percentage || 0;
        if (floodPercent < 15) {
          riskBadge.textContent = "LOW RISK";
          riskBadge.className = "risk-badge risk-low";
        } else if (floodPercent < 40) {
          riskBadge.textContent = "MODERATE RISK";
          riskBadge.className = "risk-badge risk-moderate";
        } else if (floodPercent < 70) {
          riskBadge.textContent = "HIGH RISK";
          riskBadge.className = "risk-badge risk-high";
        } else {
          riskBadge.textContent = "CRITICAL RISK";
          riskBadge.className = "risk-badge risk-critical";
        }

        const geminiElement = document.getElementById("geminiExplanation");
        const readMoreBtn = document.getElementById("readMoreBtn");
        const geminiText = data.gemini_analysis || "Analysis completed.";
        const cleanedText = cleanMarkdown(geminiText);
        const textWithClickableCitations = makeCitationsClickable(cleanedText);
        geminiElement.innerHTML = textWithClickableCitations;
        
        if (geminiText.length > 500) {
          geminiElement.classList.add('collapsed');
          readMoreBtn.style.display = 'inline-block';
        } else {
          geminiElement.classList.remove('collapsed');
          readMoreBtn.style.display = 'none';
        }

        const imageMetrics = [
          { label: "Flood Coverage", value: (data.flood_percentage || 0).toFixed(2) + "%", desc: "Percentage of image classified as flooded" },
          { label: "Flooded Pixels", value: (data.flooded_pixels || 0).toLocaleString(), desc: "Total pixels detected as flood" },
          { label: "Prediction Confidence", value: (data.prediction_confidence || 0).toFixed(2) + "%", desc: "Overall model confidence" },
          { label: "Max Confidence", value: (data.max_confidence || 0).toFixed(2) + "%", desc: "Highest confidence score" },
          { label: "Mean Confidence", value: (data.mean_confidence || 0).toFixed(2) + "%", desc: "Average confidence" },
        ];

        const imageMetricsGrid = document.getElementById("imageMetrics");
        imageMetricsGrid.innerHTML = "";
        imageMetrics.forEach(metric => {
          const card = document.createElement("div");
          card.className = "metric-card";
          card.innerHTML = `<div class="label">${metric.label}</div><div class="value">${metric.value}</div><div class="desc">${metric.desc}</div>`;
          imageMetricsGrid.appendChild(card);
        });

        const modelMetrics = [
          { label: "Model IoU", value: (data.model_iou || 0).toFixed(4), desc: "Intersection over Union", graph: "iou_graph.png" },
          { label: "Model mIoU", value: (data.model_miou || 0).toFixed(4), desc: "Mean IoU", graph: "miou_graph.png" },
          { label: "Model Accuracy", value: ((data.model_accuracy || 0) * 100).toFixed(2) + "%", desc: "Validation accuracy", graph: "accuracy_graph.png" },
          { label: "Model Precision", value: (data.model_precision || 0).toFixed(4), desc: "Precision on validation", graph: "precision_graph.png" },
          { label: "Model Recall", value: (data.model_recall || 0).toFixed(4), desc: "Recall on validation", graph: "recall_graph.png" },
          { label: "Model F1-Score", value: (data.model_f1_score || 0).toFixed(4), desc: "F1-Score", graph: "f1_graph.png" },
          { label: "Model Dice", value: (data.model_dice || 0).toFixed(4), desc: "Dice coefficient", graph: "dice_graph.png" },
        ];

        const modelMetricsGrid = document.getElementById("modelMetrics");
        modelMetricsGrid.innerHTML = "";
        modelMetrics.forEach(metric => {
          const card = document.createElement("div");
          card.className = "metric-card";
          card.innerHTML = `
            <div class="label">${metric.label}</div>
            <div class="metric-visual" onclick="openImageModal('/static/images/metrics/${metric.graph}')">
              <img src="/static/images/metrics/${metric.graph}" alt="${metric.label} graph" onerror="this.style.display='none'">
            </div>
            <div class="value">${metric.value}</div>
            <div class="desc">${metric.desc}</div>
          `;
          modelMetricsGrid.appendChild(card);
        });

        document.getElementById('results').style.display = 'block';
        document.getElementById('results').scrollIntoView({ behavior: 'smooth' });
      }

      function cleanMarkdown(text) {
        if (!text) return '';
        let html = text;
        html = html.replace(/^### (.*$)/gim, '<h3>$1</h3>');
        html = html.replace(/^## (.*$)/gim, '<h2>$1</h2>');
        html = html.replace(/^# (.*$)/gim, '<h1>$1</h1>');
        html = html.replace(/\*\*\*(.*?)\*\*\*/g, '<strong><em>$1</em></strong>');
        html = html.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        html = html.replace(/\*(.*?)\*/g, '<em>$1</em>');
        html = html.replace(/```(.*?)```/gs, '<pre><code>$1</code></pre>');
        html = html.replace(/`(.*?)`/g, '<code>$1</code>');
        html = html.replace(/^\d+\.\s+(.*)$/gim, '<li>$1</li>');
        html = html.replace(/(<li>.*<\/li>)/s, function(match) { return '<ol>' + match + '</ol>'; });
        html = html.replace(/^[\*\-]\s+(.*)$/gim, '<li>$1</li>');
        html = html.replace(/(<li>.*<\/li>)/s, function(match) { if (!match.includes('<ol>')) return '<ul>' + match + '</ul>'; return match; });
        html = html.replace(/\n\n/g, '</p><p>');
        html = '<p>' + html + '</p>';
        html = html.replace(/<p><\/p>/g, '');
        html = html.replace(/<p>(<[uo]l>)/g, '$1');
        html = html.replace(/(<\/[uo]l>)<\/p>/g, '$1');
        html = html.replace(/<p>(<h[1-6]>)/g, '$1');
        html = html.replace(/(<\/h[1-6]>)<\/p>/g, '$1');
        return html;
      }

      function toggleReadMore() {
        const geminiElement = document.getElementById("geminiExplanation");
        const readMoreBtn = document.getElementById("readMoreBtn");
        if (geminiElement.classList.contains('collapsed')) {
          geminiElement.classList.remove('collapsed');
          readMoreBtn.textContent = 'Read Less ‚ñ≤';
        } else {
          geminiElement.classList.add('collapsed');
          readMoreBtn.textContent = 'Read More ‚ñº';
        }
      }

      function enlargeImage(img) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('imageModalImg');
        modal.style.display = 'block';
        modalImg.src = img.src;
      }

      function closeImageModal() {
        document.getElementById('imageModal').style.display = 'none';
      }

      function openImageModal(imageSrc) {
        const modal = document.getElementById('imageModal');
        const modalImg = document.getElementById('imageModalImg');
        modal.style.display = 'block';
        modalImg.src = imageSrc;
      }

      async function downloadPDF() {
        if (!currentAnalysisData) {
          alert('No analysis data available to download');
          return;
        }
        const downloadBtn = document.getElementById('downloadBtn');
        downloadBtn.disabled = true;
        downloadBtn.textContent = 'Generating PDF...';
        try {
          const data = currentAnalysisData;
          const floodPercent = data.flood_percentage || 0;
          let riskLevel, riskColor;
          if (floodPercent < 15) { riskLevel = "LOW RISK"; riskColor = "#27ae60"; }
          else if (floodPercent < 40) { riskLevel = "MODERATE RISK"; riskColor = "#f39c12"; }
          else if (floodPercent < 70) { riskLevel = "HIGH RISK"; riskColor = "#e67e22"; }
          else { riskLevel = "CRITICAL RISK"; riskColor = "#e74c3c"; }
          const reportDate = new Date().toLocaleDateString();
          const htmlContent = `<!DOCTYPE html>
<html><head><meta charset="utf-8"><title>DeepFlood Analysis Report</title>
<style>@page { size: A4; margin: 15mm; } * { margin: 0; padding: 0; box-sizing: border-box; } body { font-family: Arial, sans-serif; line-height: 1.6; color: #2c3e50; background: white; } .report-container { max-width: 210mm; margin: 0 auto; padding: 20px; } .header { background: linear-gradient(135deg, #1a2b5c, #2d1b3d); color: white; padding: 30px; text-align: center; margin-bottom: 30px; } .header h1 { font-size: 28px; margin-bottom: 10px; font-weight: 300; } .header .subtitle { font-size: 14px; opacity: 0.9; } .metadata { background: #f8f9fa; padding: 20px; border-radius: 8px; margin-bottom: 25px; border-left: 4px solid #64c8ff; } .metadata p { margin: 8px 0; font-size: 13px; } .metadata strong { color: #1a2b5c; display: inline-block; width: 150px; } .section { margin: 30px 0; page-break-inside: avoid; } .section-title { color: #1a2b5c; font-size: 20px; font-weight: 600; margin-bottom: 15px; padding-bottom: 8px; border-bottom: 3px solid #64c8ff; } .risk-badge { display: inline-block; padding: 15px 40px; border-radius: 25px; color: white; font-weight: bold; font-size: 18px; margin: 20px 0; background: ${riskColor}; } .metrics-table { width: 100%; border-collapse: collapse; margin: 20px 0; box-shadow: 0 2px 8px rgba(0,0,0,0.1); } .metrics-table th { background: #1a2b5c; color: white; padding: 12px; text-align: left; font-weight: 600; font-size: 13px; } .metrics-table td { padding: 12px; border-bottom: 1px solid #e0e0e0; font-size: 12px; } .metrics-table tr:nth-child(even) { background: #f8f9fa; } .metrics-table td:first-child { font-weight: 600; color: #1a2b5c; } .metrics-table td:nth-child(2) { text-align: center; color: #64c8ff; font-weight: bold; font-size: 14px; } .analysis-box { background: linear-gradient(135deg, rgba(102,126,234,0.1), rgba(118,75,162,0.1)); border: 2px solid #667eea; padding: 20px; border-radius: 10px; margin: 20px 0; } .analysis-box h3 { color: #667eea; margin-bottom: 15px; font-size: 16px; } .analysis-box p { line-height: 1.8; font-size: 13px; text-align: justify; } .image-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin: 20px 0; } .image-card { border: 2px solid #e0e0e0; border-radius: 8px; padding: 15px; text-align: center; page-break-inside: avoid; } .image-card h4 { color: #1a2b5c; margin-bottom: 10px; font-size: 14px; } .image-card img { max-width: 100%; height: auto; border-radius: 5px; border: 1px solid #ccc; } .image-card p { margin-top: 8px; font-size: 11px; color: #7f8c8d; font-style: italic; } .footer { margin-top: 40px; padding-top: 20px; border-top: 2px solid #e0e0e0; text-align: center; font-size: 11px; color: #7f8c8d; } @media print { body { print-color-adjust: exact; -webkit-print-color-adjust: exact; } .section { page-break-inside: avoid; } }</style></head><body><div class="report-container">
<div class="header"><h1>DEEPFLOOD SEGMENTATION REPORT</h1><div class="subtitle">DeepLabV3+ Deep Learning Model with Grad-CAM Explainability</div></div>
<div class="metadata"><p><strong>Report Generated:</strong> ${reportDate}</p><p><strong>Model Architecture:</strong> DeepLabV3+ Semantic Segmentation</p><p><strong>Analysis Method:</strong> Grad-CAM + Binary Classification</p><p><strong>Report ID:</strong> FLD-${Date.now()}</p></div>
<div class="section"><h2 class="section-title">Risk Assessment</h2><center><div class="risk-badge">${riskLevel}</div></center></div>
<div class="section"><h2 class="section-title">Analysis Metrics - This Image</h2><table class="metrics-table"><thead><tr><th>Metric</th><th>Value</th><th>Description</th></tr></thead><tbody>
<tr><td>Flood Coverage</td><td>${(data.flood_percentage || 0).toFixed(2)}%</td><td>Percentage of image classified as flooded</td></tr>
<tr><td>Flooded Pixels</td><td>${(data.flooded_pixels || 0).toLocaleString()}</td><td>Total pixels detected as flood</td></tr>
<tr><td>Prediction Confidence</td><td>${(data.prediction_confidence || 0).toFixed(2)}%</td><td>Overall model confidence</td></tr>
<tr><td>Max Confidence</td><td>${(data.max_confidence || 0).toFixed(2)}%</td><td>Highest confidence score</td></tr>
<tr><td>Mean Confidence</td><td>${(data.mean_confidence || 0).toFixed(2)}%</td><td>Average confidence</td></tr></tbody></table></div>
<div class="section"><h2 class="section-title">Model Performance (Validation Set)</h2><table class="metrics-table"><thead><tr><th>Metric</th><th>Value</th><th>Description</th></tr></thead><tbody>
<tr><td>IoU</td><td>${(data.model_iou || 0).toFixed(4)}</td><td>Intersection over Union</td></tr>
<tr><td>mIoU</td><td>${(data.model_miou || 0).toFixed(4)}</td><td>Mean IoU</td></tr>
<tr><td>Accuracy</td><td>${((data.model_accuracy || 0) * 100).toFixed(2)}%</td><td>Validation accuracy</td></tr>
<tr><td>Precision</td><td>${(data.model_precision || 0).toFixed(4)}</td><td>Precision</td></tr>
<tr><td>Recall</td><td>${(data.model_recall || 0).toFixed(4)}</td><td>Recall</td></tr>
<tr><td>F1-Score</td><td>${(data.model_f1_score || 0).toFixed(4)}</td><td>F1-Score</td></tr>
<tr><td>Dice Coefficient</td><td>${(data.model_dice || 0).toFixed(4)}</td><td>Dice coefficient</td></tr></tbody></table></div>
${data.gemini_analysis ? `<div class="section"><div class="analysis-box"><h3>AI-Generated Expert Analysis</h3><p>${data.gemini_analysis.replace(/\*\*/g, '').replace(/\n/g, '<br>')}</p></div></div>` : ''}
<div class="section" style="page-break-before:always;"><h2 class="section-title">Visual Analysis Results</h2><div class="image-grid">
<div class="image-card"><h4>Original Image</h4><img src="data:image/png;base64,${data.original}" alt="Original"><p>The original aerial/satellite image</p></div>
<div class="image-card"><h4>Segmentation Mask</h4><img src="data:image/png;base64,${data.prediction}" alt="Prediction"><p>White = Flood | Black = No Flood</p></div>
<div class="image-card"><h4>Grad-CAM Heatmap</h4><img src="data:image/png;base64,${data.gradcam}" alt="Grad-CAM"><p>Model attention visualization</p></div>
<div class="image-card"><h4>Flood Overlay</h4><img src="data:image/png;base64,${data.overlay}" alt="Overlay"><p>Red overlay shows detected flood areas</p></div>
</div></div>
<div class="footer"><p>DeepFlood Segmentation System | Powered by DeepLabV3+ AI</p><p>Report generated automatically - For disaster management use</p></div>
</div></body></html>`;
          const printWindow = window.open('', '', 'width=800,height=600');
          printWindow.document.write(htmlContent);
          printWindow.document.close();
          setTimeout(() => { printWindow.print(); printWindow.close(); }, 1000);
        } catch (error) {
          console.error('Error generating PDF:', error);
          alert('Error generating PDF report. Please try again.');
        } finally {
          downloadBtn.disabled = false;
          downloadBtn.textContent = 'Download Report PDF';
        }
      }

      window.onclick = function(event) {
        const welcomeModal = document.getElementById('welcomeModal');
        const historyModal = document.getElementById('historyModal');
        if (event.target == welcomeModal) welcomeModal.style.display = 'none';
        if (event.target == historyModal) historyModal.style.display = 'none';
      }
    </script>
  </body>
</html>